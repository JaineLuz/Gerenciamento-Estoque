<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Vendas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            background-color: rgb(11, 11, 87);
        }
    </style>
</head>

<body>
    <div class="container mt-4">
        <h1 class="text-center" style="color: white;">Relatório de Vendas</h1>
        <div class="mb-3 text-end">
            <button id="estoque" class="btn btn-primary">Voltar ao Estoque</button>
            <button class="btn btn-success" onclick="carregarVendas();">Adicionar
                Venda</button>
        </div>
        <table class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Produto</th>
                    <th>Quantidade Vendida</th>
                    <th>Valor Unitário</th>
                    <th>Faturamento</th>
                    <th>Despesas</th>
                    <th>Lucro</th>
                    <th>Data</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="tabela-vendas">
                <!-- Linhas dinâmicas de vendas serão carregadas aqui -->
            </tbody>
        </table>
    </div>

    <!-- Modal de Edição -->
    <div class="modal fade" id="modal-editar" tabindex="-1" aria-labelledby="modal-editar-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-editar-label">Editar Venda</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="mb-3">
                            <label for="produto" class="form-label">Produto</label>
                            <input type="text" class="form-control" id="produto" required>
                        </div>
                        <div class="mb-3">
                            <label for="quantidade" class="form-label">Quantidade</label>
                            <input type="number" class="form-control" id="quantidade" required>
                        </div>
                        <div class="mb-3">
                            <label for="valorUnitario" class="form-label">Valor Unitário</label>
                            <input type="number" step="0.01" class="form-control" id="valorUnitario" required>
                        </div>
                        <div class="mb-3">
                            <label for="custoUnitario" class="form-label">Valor de Despesas</label>
                            <input type="number" step="0.01" class="form-control" id="valorDespesas" required>
                        </div>
                        <div class="mb-3">
                            <label for="data" class="form-label">Data</label>
                            <input type="date" class="form-control" id="data" required>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="salvarEdicao()">Salvar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Adicionar -->
    <div class="modal fade" id="modal-adicionar" tabindex="-1" aria-labelledby="modal-adicionar-label"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-adicionar-label">Adicionar Venda</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="mb-3">
                            <label for="novoProduto" class="form-label">Produto</label>
                            <input type="text" class="form-control" id="novoProduto" required>
                        </div>
                        <div class="mb-3">
                            <label for="novaQuantidade" class="form-label">Quantidade</label>
                            <input type="number" class="form-control" id="novaQuantidade" required>
                        </div>
                        <div class="mb-3">
                            <label for="novoValorUnitario" class="form-label">Valor Unitário</label>
                            <input type="number" step="0.01" class="form-control" id="novoValorUnitario" required>
                        </div>
                        <div class="mb-3">
                            <label for="novoCustoUnitario" class="form-label">Valor de Despesas</label>
                            <input type="number" step="0.01" class="form-control" id="novoValorDespesas" required>
                        </div>
                        <div class="mb-3">
                            <label for="novaData" class="form-label">Data</label>
                            <input type="date" class="form-control" id="novaData" required>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="adicionarVenda()">Adicionar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script defer>
        const vendas = [];
        let vendaEditando = null;

        // Função para calcular faturamento e lucro
        function calcularFaturamentoLucro(venda) {
            const faturamento = venda.quantidade * venda.valorUnitario;
            const lucro = venda.quantidade * (venda.valorUnitario - venda.valorDespesas);
            return { faturamento, lucro };
        }

        // Função para carregar vendas na tabela
        function carregarProdutos() {
            const selectProduto = document.getElementById("produto");

            // Faz a requisição para a API para buscar os produtos
            fetch('http://localhost:3000/produtos') // A URL da sua API, altere conforme necessário
                .then(response => response.json()) // Converte a resposta para JSON
                .then(produtos => {
                    selectProduto.innerHTML = ""; // Limpa as opções existentes no select

                    // Adiciona uma opção padrão no select
                    const optionDefault = document.createElement("option");
                    optionDefault.value = "";
                    optionDefault.textContent = "Selecione um Produto";
                    selectProduto.appendChild(optionDefault);

                    // Preenche o select com os produtos recebidos da API
                    produtos.forEach(produto => {
                        const option = document.createElement("option");
                        option.value = produto.id;  // Produto ID
                        option.textContent = produto.nome;  // Nome do produto
                        selectProduto.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error("Erro ao carregar produtos:", error);
                    alert("Erro ao carregar produtos.");
                });
        }

        async function carregarVendas() {
            try {
                // Faz uma requisição ao backend para buscar os produtos
                const response = await fetch('http://localhost:3000/vendas');
                if (response.ok) {
                    // Preenche o array global com os produtos retornados
                    vendas = await response.json();
                    console.log("Vendas carregadas com sucesso:", vendas);

                    // Atualiza a tabela na interface
                    const tabela = document.getElementById('tabela-vendas');
                    tabela.innerHTML = ''; // Limpa a tabela antes de preenchê-la

                    vendas.forEach((venda, index) => {
                        tabela.innerHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${produto.nome}</td>
                        <td>${venda.quantPecas}</td>
                        <td>R$ ${venda.faturamento.toFixed(2)}</td>
                        <td>R$${venda.valorDespesas.toFixed(2)}</td>
                        <td>${venda.dataVenda}</td>
                        <td>
                            <button id="atualizar" class="btn btn-warning btn-sm" onclick="editarVenda(${venda.id})">Editar</button>
                        </td>
                    </tr>
                `;
                    });
                } else {
                    console.error("Erro ao carregar vendas:", response.statusText);
                    alert('Erro ao carregar vendas. Tente novamente mais tarde.');
                }
            } catch (error) {
                console.error("Erro ao conectar ao servidor:", error);
                alert('Erro ao conectar ao servidor. Tente novamente mais tarde.');
            }
        }

        // Carregar os produtos assim que a página for carregada
        document.addEventListener('DOMContentLoaded', () => {
            carregarProdutos();
        });

        // Prepara a edição de uma venda
        function prepararEdicao(index) {
            vendaEditando = index;
            const venda = vendas[index];
            document.getElementById("produto").value = venda.produto;
            document.getElementById("quantidade").value = venda.quantidade;
            document.getElementById("valorUnitario").value = venda.valorUnitario;
            document.getElementById("valorDespesas").value = venda.valorDespesas;
            document.getElementById("data").value = venda.dataVenda.toISOString().split('T')[0];

            const modal = new bootstrap.Modal(document.getElementById("modal-editar"));
            modal.show();
        }

        // Salva uma edição de venda
        function salvarEdicao() {
            if (vendaEditando !== null) {
                vendas[vendaEditando] = {
                    id: vendas[vendaEditando].id,
                    produto: document.getElementById("produto").value,
                    quantidade: parseInt(document.getElementById("quantidade").value),
                    valorUnitario: parseFloat(document.getElementById("valorUnitario").value),
                    custoUnitario: parseFloat(document.getElementById("custoUnitario").value),
                    dataVenda: new Date(document.getElementById("data").value),
                };

                vendaEditando = null;
                carregarVendas();
                bootstrap.Modal.getInstance(document.getElementById("modal-editar")).hide();
            }
        }

        // Abre o modal para adicionar nova venda
        function abrirAdicionarVenda() {
            const novoProduto = document.getElementById("novoProduto");
            const novaQuantidade = document.getElementById("novaQuantidade");
            const novoValorUnitario = document.getElementById("novoValorUnitario");
            const novoValorDespesas = document.getElementById("novoValorDespesas");
            const dataNovaVenda = document.getElementById("dataNovaVenda");

            if (!novoProduto || !novaQuantidade || !novoValorUnitario || !novoValorDespesas || !dataNovaVenda) {
                console.error("Um ou mais elementos do modal 'Adicionar Venda' não foram encontrados.");
                return;
            }

            novoProduto.value = "";
            novaQuantidade.value = "";
            novoValorUnitario.value = "";
            novoValorDespesas.value = "";
            dataNovaVenda.value = "";

            const modal = new bootstrap.Modal(document.getElementById("modal-adicionar"));
            modal.show();
        }


        // Salva nova venda
        function salvarNovaVenda() {
            const novaVenda = {
                id: vendas.length + 1,
                produto: document.getElementById("novoProduto").value,
                quantidade: parseInt(document.getElementById("novaQuantidade").value),
                valorUnitario: parseFloat(document.getElementById("novoValorUnitario").value),
                valorDespesas: parseFloat(document.getElementById("novoValorDespesas").value),
                dataVenda: new Date(document.getElementById("dataNovaVenda").value),
            };

            vendas.push(novaVenda);
            carregarVendas();
            bootstrap.Modal.getInstance(document.getElementById("modal-adicionar")).hide();
        }

        // Redirecionar para estoque.html
        document.getElementById('estoque').addEventListener('click', () => {
            window.location.href = '/estoque';
        });

        window.onload = carregarVendas;
    </script>
</body>

</html>